#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    source /opt/gokku/scripts/plugin-helpers.sh
fi

SERVICE_NAME="$1"

if [ -z "$SERVICE_NAME" ]; then
    echo "Usage: $0 <service-name>"
    echo "Example: $0 ssl-proxy"
    exit 1
fi

echo "-----> Uninstalling Let's Encrypt service: $SERVICE_NAME"

# Check if service exists
SERVICE_DIR="/opt/gokku/services/$SERVICE_NAME"
if [ ! -d "$SERVICE_DIR" ]; then
    echo "-----> Service '$SERVICE_NAME' not found"
    exit 0
fi

# Remove cron job
CRON_FILE="/etc/cron.d/gokku-letsencrypt-$SERVICE_NAME"
if [ -f "$CRON_FILE" ]; then
    echo "-----> Removing auto-renewal cron job..."
    rm -f "$CRON_FILE"
    echo "       Cron job removed: $CRON_FILE"
fi

# Remove renewal log file
RENEWAL_LOG="/var/log/gokku-letsencrypt-$SERVICE_NAME.log"
if [ -f "$RENEWAL_LOG" ]; then
    echo "-----> Removing renewal log file..."
    rm -f "$RENEWAL_LOG"
    echo "       Log file removed: $RENEWAL_LOG"
fi

# Attempt to unlink certificates from nginx service using updated command
if command -v gokku >/dev/null 2>&1; then
    echo "-----> Removing nginx SSL symlinks (if any)"
    gokku letsencrypt:unlink-nginx "$SERVICE_NAME" || true
else
    echo "-----> Warning: 'gokku' command not found; skip nginx unlink step"
fi

# Remove service directory
echo "-----> Removing service directory: $SERVICE_DIR"
rm -rf "$SERVICE_DIR"

# Clean up any linked app configurations
echo "-----> Cleaning up linked applications..."
for app_dir in /opt/gokku/apps/*; do
    if [ -d "$app_dir" ]; then
        # Remove Let's Encrypt service links from app configs
        if [ -f "$app_dir/gokku.yml" ]; then
            # This would need to be implemented based on how Gokku stores service links
            # For now, we'll just log that cleanup might be needed
            echo "       Note: Check app configurations for Let's Encrypt service links"
        fi
    fi
done

# Clean up any Let's Encrypt images (keep the base image)
echo "-----> Cleaning up Let's Encrypt images..."
# Only remove custom Let's Encrypt images if any were created
# Keep the base certbot/certbot image for other services

echo "-----> Let's Encrypt service uninstalled successfully"
echo "       Service: $SERVICE_NAME"
echo "       All certificates, configurations, and cron jobs removed"
echo ""
echo "-----> Note: SSL certificates have been removed"
echo "       If you need to keep certificates, backup them before uninstalling"
