#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    source /opt/gokku/scripts/plugin-helpers.sh
fi

echo "-----> Installing Let's Encrypt plugin"

# Create plugin directory
PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
mkdir -p "$PLUGIN_DIR/certs"
mkdir -p "$PLUGIN_DIR/accounts"
mkdir -p "$PLUGIN_DIR/logs"

sudo chown -R "$(whoami):$(whoami)" "$PLUGIN_DIR" 2>/dev/null || true
sudo chmod -R 755 "$PLUGIN_DIR" 2>/dev/null || true

# Check if plugin is already installed
if [ -f "$PLUGIN_DIR/config.json" ]; then
    echo "-----> Let's Encrypt plugin is already installed"
    echo "       Plugin directory: $PLUGIN_DIR"
    exit 0
fi

# Migrate old installations that only have plugin.conf
if [ -f "$PLUGIN_DIR/plugin.conf" ] && [ ! -f "$PLUGIN_DIR/config.json" ]; then
    echo "-----> Migrating old installation..."
    cat > "$PLUGIN_DIR/config.json" << EOF
{
    "name": "letsencrypt",
    "type": "ssl",
    "version": "1.0.0",
    "description": "Let's Encrypt SSL certificate management plugin for Gokku"
}
EOF
    echo "-----> Migration complete"
    exit 0
fi

# Create plugin configuration
cat > "$PLUGIN_DIR/config.json" << EOF
{
    "name": "letsencrypt",
    "type": "ssl",
    "version": "1.0.0",
    "description": "Let's Encrypt SSL certificate management plugin for Gokku"
}
EOF

# Create plugin.conf for internal use
cat > "$PLUGIN_DIR/plugin.conf" << EOF
{
    "plugin_name": "letsencrypt",
    "plugin_type": "ssl",
    "plugin_dir": "$PLUGIN_DIR",
    "certs_dir": "$PLUGIN_DIR/certs",
    "accounts_dir": "$PLUGIN_DIR/accounts",
    "logs_dir": "$PLUGIN_DIR/logs",
    "domains": [],
    "created_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
    "status": "installed"
}
EOF

# Set proper permissions
chmod -R 755 "$PLUGIN_DIR" 2>/dev/null || true

# Pull certbot image
echo "-----> Pulling certbot Docker image..."
docker pull certbot/certbot:latest 2>/dev/null || true

echo "-----> Let's Encrypt plugin installed successfully"
echo "       Plugin directory: $PLUGIN_DIR"
echo "       Certificates: $PLUGIN_DIR/certs"
echo "       Accounts: $PLUGIN_DIR/accounts"
echo "       Logs: $PLUGIN_DIR/logs"
echo ""
echo "-----> Next steps:"
echo "       1. Create certificate: gokku letsencrypt:create <domain> <email>"
echo "       2. Setup auto-renewal: gokku letsencrypt:auto-renew"
echo "       3. Link to nginx: gokku letsencrypt:link-nginx <nginx-service>"
echo ""
echo "-----> Example usage:"
echo "       gokku letsencrypt:create example.com contact@example.com"
echo "       gokku letsencrypt:auto-renew"
echo "       gokku letsencrypt:link-nginx nginx-lb"
