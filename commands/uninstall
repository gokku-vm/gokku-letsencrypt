#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    source /opt/gokku/scripts/plugin-helpers.sh
fi

echo "-----> Uninstalling Let's Encrypt plugin"

# Check if plugin exists
PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
if [ ! -d "$PLUGIN_DIR" ]; then
    echo "-----> Let's Encrypt plugin not found"
    exit 0
fi

# Remove cron job
CRON_FILE="/etc/cron.d/gokku-letsencrypt"
if [ -f "$CRON_FILE" ]; then
    echo "-----> Removing auto-renewal cron job..."
    rm -f "$CRON_FILE"
    echo "       Cron job removed: $CRON_FILE"
fi

# Remove renewal log file
RENEWAL_LOG="/var/log/gokku-letsencrypt.log"
if [ -f "$RENEWAL_LOG" ]; then
    echo "-----> Removing renewal log file..."
    rm -f "$RENEWAL_LOG"
    echo "       Log file removed: $RENEWAL_LOG"
fi

# Unlink certificates from services
SERVICES_ROOT="/opt/gokku/services"
if [ -d "$SERVICES_ROOT" ]; then
    echo "-----> Removing SSL symlinks from services..."
    while IFS= read -r -d '' cert_path; do
        ssl_dir=$(dirname "$cert_path")
        service_name=$(basename "$(dirname "$ssl_dir")")
        domain=$(basename "$cert_path" .crt)
        target=$(readlink "$cert_path" 2>/dev/null || true)

        if [ -n "$target" ] && [[ "$target" == "$PLUGIN_DIR/certs/$domain/"* || "$target" == "$PLUGIN_DIR/certs/$domain/fullchain.pem" ]]; then
            echo "       Service: $service_name (domain: $domain)"
            rm -f "$cert_path"
            key_path="$ssl_dir/$domain.key"
            if [ -L "$key_path" ]; then
                rm -f "$key_path"
            fi
        fi
    done < <(find "$SERVICES_ROOT" -mindepth 2 -maxdepth 2 -type l -name "*.crt" -print0 2>/dev/null)
fi

# Remove plugin directory
echo "-----> Removing plugin directory: $PLUGIN_DIR"

# Check for files with root ownership (created by certbot in Docker containers)
if [ -d "$PLUGIN_DIR/logs" ]; then
    if ls -la "$PLUGIN_DIR/logs" | grep -q "root root"; then
        echo "-----> Detected files owned by root in logs directory"
        echo "       Using sudo to remove..."
        sudo rm -rf "$PLUGIN_DIR"
    else
        rm -rf "$PLUGIN_DIR"
    fi
else
    rm -rf "$PLUGIN_DIR"
fi

echo "-----> Let's Encrypt plugin uninstalled successfully"
echo "       All certificates, configurations, and cron jobs removed"
echo ""
echo "-----> Note: SSL certificates have been removed"
echo "       If you need to keep certificates, backup them before uninstalling"

