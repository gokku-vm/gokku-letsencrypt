#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    source /opt/gokku/scripts/plugin-helpers.sh
fi

echo "-----> Setting up auto-renewal for Let's Encrypt plugin"

# Check if plugin is installed
PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
if [ ! -d "$PLUGIN_DIR" ]; then
    echo "-----> Let's Encrypt plugin not installed"
    echo "       Run 'gokku letsencrypt:install' first"
    exit 1
fi

# Ensure renewal script exists
RENEWAL_SCRIPT="$PLUGIN_DIR/renew-certificates.sh"
if [ ! -f "$RENEWAL_SCRIPT" ]; then
    echo "-----> Renewal script not found, creating..."

    cat > "$RENEWAL_SCRIPT" << 'EOF'
#!/bin/bash

# Let's Encrypt certificate renewal script
PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"

echo "$(date): Starting certificate renewal for Let's Encrypt plugin"

# Check if plugin directory exists
if [ ! -d "$PLUGIN_DIR" ]; then
    echo "$(date): Plugin directory not found: $PLUGIN_DIR"
    exit 1
fi

# Find and temporarily stop nginx containers that are using port 80
CONTAINERS_TO_RESTART=()
for container in $(docker ps --format "{{.Names}}"); do
    if docker port "$container" 2>/dev/null | grep -qE ":80/"; then
        docker stop "$container" > /dev/null 2>&1
        CONTAINERS_TO_RESTART+=("$container")
    fi
done

# Renew certificates using certbot (HTTP-01 validation only needs port 80)
docker run --rm \
    -v "$PLUGIN_DIR:/etc/letsencrypt" \
    -v "$PLUGIN_DIR/logs:/var/log/letsencrypt" \
    -p 80:80 \
    certbot/certbot renew \
    --preferred-challenges http \
    --config-dir "/etc/letsencrypt" \
    --work-dir "/etc/letsencrypt" \
    --logs-dir "/var/log/letsencrypt" \
    --non-interactive \
    --quiet

RENEW_EXIT_CODE=$?

# Restart containers that were temporarily stopped
for container in "${CONTAINERS_TO_RESTART[@]}"; do
    docker start "$container" > /dev/null 2>&1
done

# Fix permissions for files created by certbot (root in Docker)
# Note: chmod on root-owned files will fail silently, which is OK
chmod -R u+rwX "$PLUGIN_DIR" 2>/dev/null || true

if [ $RENEW_EXIT_CODE -eq 0 ]; then
    echo "$(date): Certificate renewal completed successfully"

    # Copy renewed certificates from live/ to certs/ directory
    if [ -d "$PLUGIN_DIR/live" ]; then
        for domain_dir in "$PLUGIN_DIR/live"/*; do
            if [ -d "$domain_dir" ]; then
                domain=$(basename "$domain_dir")
                mkdir -p "$PLUGIN_DIR/certs/$domain"
                if [ -f "$domain_dir/fullchain.pem" ]; then
                    cp -f "$domain_dir/fullchain.pem" "$PLUGIN_DIR/certs/$domain/" 2>/dev/null || sudo cp -f "$domain_dir/fullchain.pem" "$PLUGIN_DIR/certs/$domain/" 2>/dev/null
                fi
                if [ -f "$domain_dir/privkey.pem" ]; then
                    cp -f "$domain_dir/privkey.pem" "$PLUGIN_DIR/certs/$domain/" 2>/dev/null || sudo cp -f "$domain_dir/privkey.pem" "$PLUGIN_DIR/certs/$domain/" 2>/dev/null
                fi
            fi
        done
    fi

    # Update certificate symlinks for all linked nginx services
    if [ -f "$PLUGIN_DIR/nginx-services" ]; then
        while read -r nginx_service; do
            if [ -n "$nginx_service" ]; then
                NGINX_DIR="/opt/gokku/services/$nginx_service"
                NGINX_SSL_DIR="$NGINX_DIR/ssl"

                if [ -d "$NGINX_DIR" ] && [ -d "$NGINX_SSL_DIR" ] && [ -d "$PLUGIN_DIR/certs" ]; then
                    echo "$(date): Updating certificate symlinks for nginx service: $nginx_service"
                    for domain_dir in "$PLUGIN_DIR/certs"/*; do
                        if [ -d "$domain_dir" ]; then
                            domain=$(basename "$domain_dir")
                            if [ -f "$domain_dir/fullchain.pem" ] && [ -f "$domain_dir/privkey.pem" ]; then
                                ln -sf "$domain_dir/fullchain.pem" "$NGINX_SSL_DIR/$domain.crt"
                                ln -sf "$domain_dir/privkey.pem" "$NGINX_SSL_DIR/$domain.key"
                            fi
                        fi
                    done
                    echo "$(date): Certificate symlinks updated for $nginx_service"
                fi
            fi
        done < "$PLUGIN_DIR/nginx-services"
    fi
else
    echo "$(date): Certificate renewal failed"
    exit 1
fi
EOF

    chmod +x "$RENEWAL_SCRIPT"
fi

# Create cron job
CRON_FILE="/etc/cron.d/gokku-letsencrypt"
cat > "$CRON_FILE" << EOF
# Auto-renewal for Let's Encrypt plugin
# Runs every day at 2:30 AM
30 2 * * * root $RENEWAL_SCRIPT >> /var/log/gokku-letsencrypt.log 2>&1
EOF

# Set proper permissions
chmod 644 "$CRON_FILE"

echo "-----> Auto-renewal configured successfully"
echo "       Cron file: $CRON_FILE"
echo "       Renewal script: $RENEWAL_SCRIPT"
echo "       Schedule: Daily at 2:30 AM"
echo "       Log file: /var/log/gokku-letsencrypt.log"

# Test the renewal script
echo "-----> Testing renewal script..."
if "$RENEWAL_SCRIPT"; then
    echo "-----> Renewal script test successful"
else
    echo "-----> Renewal script test failed"
    echo "       Check the script and try again"
fi

echo ""
echo "-----> Auto-renewal setup complete"
echo "       Certificates will be automatically renewed every 90 days"
echo "       Manual renewal: gokku letsencrypt:renew"
