#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    # shellcheck disable=SC1091
    source /opt/gokku/scripts/plugin-helpers.sh
fi

NGINX_SERVICE="$1"

if [ -z "$NGINX_SERVICE" ]; then
    echo "Usage: $0 <nginx-service>"
    echo "Example: $0 nginx-lb"
    exit 1
fi

PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
CERTS_DIR="$PLUGIN_DIR/certs"
SERVICES_ROOT="/opt/gokku/services"
SERVICE_DIR="$SERVICES_ROOT/$NGINX_SERVICE"
SSL_DIR="$SERVICE_DIR/ssl"

echo "-----> Unlinking Let's Encrypt certificates from nginx service '$NGINX_SERVICE'"

if [ ! -d "$PLUGIN_DIR" ]; then
    echo "-----> Let's Encrypt plugin not installed"
    exit 1
fi

if [ ! -d "$SERVICE_DIR" ]; then
    echo "-----> Service directory not found: $SERVICE_DIR"
    exit 1
fi

if [ ! -d "$SSL_DIR" ]; then
    echo "-----> SSL directory not found for service '$NGINX_SERVICE'"
    exit 0
fi

if [ ! -d "$CERTS_DIR" ]; then
    echo "-----> No certificates directory found in plugin"
fi

# Remove symlinks that point to plugin certificates
removed_any=false
if [ -d "$CERTS_DIR" ]; then
    while IFS= read -r -d '' cert_dir; do
        domain=$(basename "$cert_dir")
        cert_path="$SSL_DIR/$domain.crt"
        key_path="$SSL_DIR/$domain.key"

        if [ -L "$cert_path" ] && [ "$(readlink "$cert_path")" = "$cert_dir/fullchain.pem" ]; then
            rm -f "$cert_path"
            echo "       Removed certificate symlink: $cert_path"
            removed_any=true
        fi
        if [ -L "$key_path" ] && [ "$(readlink "$key_path")" = "$cert_dir/privkey.pem" ]; then
            rm -f "$key_path"
            echo "       Removed key symlink: $key_path"
            removed_any=true
        fi
    done < <(find "$CERTS_DIR" -mindepth 1 -maxdepth 1 -type d -print0)
fi

if [ "$removed_any" = false ]; then
    echo "       No certificate symlinks found for this service"
fi

echo "-----> Successfully unlinked nginx service: $NGINX_SERVICE"
echo ""
echo "-----> Certificates remain available in $CERTS_DIR"
echo "       Re-link anytime: gokku letsencrypt:link-nginx $NGINX_SERVICE"
