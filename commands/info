#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    source /opt/gokku/scripts/plugin-helpers.sh
fi

DOMAIN="$1"
SERVICE_FILTER="$2"

if [ -z "$DOMAIN" ]; then
    echo "Usage: $0 <domain> [nginx-service]"
    echo "Example: $0 example.com nginx-lb"
    exit 1
fi

PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
CERT_DIR="$PLUGIN_DIR/certs/$DOMAIN"
SERVICES_ROOT="/opt/gokku/services"

echo "-----> Certificate information for $DOMAIN"

if [ ! -d "$PLUGIN_DIR" ]; then
    echo "-----> Let's Encrypt plugin not installed"
    exit 1
fi

if [ ! -d "$CERT_DIR" ]; then
    echo "-----> Certificate for domain '$DOMAIN' not found"
    echo "       Run 'gokku letsencrypt:create $DOMAIN [email]' to create certificate"
    exit 1
fi

FULLCHAIN="$CERT_DIR/fullchain.pem"
PRIVKEY="$CERT_DIR/privkey.pem"

if [ ! -f "$FULLCHAIN" ] || [ ! -f "$PRIVKEY" ]; then
    echo "-----> Certificate files incomplete for domain '$DOMAIN'"
    exit 1
fi

echo "-----> Certificate Details:"
echo "       Domain: $DOMAIN"
echo "       Certificate: $FULLCHAIN"
echo "       Private key: $PRIVKEY"
echo ""

if command -v openssl >/dev/null 2>&1; then
    echo "-----> Certificate Information:"
    subject=$(openssl x509 -subject -noout -in "$FULLCHAIN" 2>/dev/null)
    issuer=$(openssl x509 -issuer -noout -in "$FULLCHAIN" 2>/dev/null)
    not_before=$(openssl x509 -startdate -noout -in "$FULLCHAIN" 2>/dev/null | cut -d= -f2)
    not_after=$(openssl x509 -enddate -noout -in "$FULLCHAIN" 2>/dev/null | cut -d= -f2)
    fingerprint=$(openssl x509 -fingerprint -noout -in "$FULLCHAIN" 2>/dev/null)
    serial=$(openssl x509 -serial -noout -in "$FULLCHAIN" 2>/dev/null)

    [ -n "$subject" ] && echo "       Subject: $subject"
    [ -n "$issuer" ] && echo "       Issuer: $issuer"

    if [ -n "$not_before" ] || [ -n "$not_after" ]; then
        echo "       Validity:"
        [ -n "$not_before" ] && echo "         Not before: $not_before"
        [ -n "$not_after" ] && echo "         Not after: $not_after"
    fi

    if [ -n "$not_after" ]; then
        expiry_timestamp=$(date -d "$not_after" +%s 2>/dev/null || date -j -f "%b %d %H:%M:%S %Y %Z" "$not_after" +%s 2>/dev/null)
        if [ -n "$expiry_timestamp" ]; then
            current_timestamp=$(date +%s)
            days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))
            if [ $days_until_expiry -gt 0 ]; then
                echo "         Days until expiry: $days_until_expiry"
                if [ $days_until_expiry -lt 30 ]; then
                    echo "         WARNING: Certificate expires in less than 30 days!"
                fi
            else
                echo "         WARNING: Certificate has expired!"
            fi
        fi
    fi

    [ -n "$fingerprint" ] && echo "       Fingerprint: $fingerprint"
    [ -n "$serial" ] && echo "       Serial: $serial"

    san=$(openssl x509 -text -noout -in "$FULLCHAIN" 2>/dev/null | grep -A1 "Subject Alternative Name" | tail -1)
    if [ -n "$san" ]; then
        echo ""
        echo "       Subject Alternative Names:"
        echo "$san" | tr ',' '\n' | sed 's/^/         /'
    fi
    echo ""
else
    echo "-----> OpenSSL not available for detailed certificate information"
    echo ""
fi

echo "-----> Nginx Integration:"

linked_services=()
add_service_if_linked() {
    local svc="$1"
    local ssl_dir="$SERVICES_ROOT/$svc/ssl"
    local cert_path="$ssl_dir/$DOMAIN.crt"
    local key_path="$ssl_dir/$DOMAIN.key"

    if [ -f "$cert_path" ] || [ -f "$key_path" ]; then
        for existing in "${linked_services[@]}"; do
            if [ "$existing" = "$svc" ]; then
                return
            fi
        done
        linked_services+=("$svc")
        echo "       Service: $svc"
        if [ -L "$cert_path" ]; then
            echo "         Certificate symlink: $cert_path -> $(readlink "$cert_path")"
        elif [ -f "$cert_path" ]; then
            echo "         Certificate file: $cert_path"
        else
            echo "         Certificate missing: $cert_path"
        fi

        if [ -L "$key_path" ]; then
            echo "         Key symlink: $key_path -> $(readlink "$key_path")"
        elif [ -f "$key_path" ]; then
            echo "         Key file: $key_path"
        else
            echo "         Key missing: $key_path"
        fi
    fi
}

if [ -n "$SERVICE_FILTER" ]; then
    add_service_if_linked "$SERVICE_FILTER"
else
    if [ ${#linked_services[@]} -eq 0 ] && [ -d "$SERVICES_ROOT" ]; then
        while IFS= read -r -d '' ssl_dir; do
            svc_name=$(basename "$(dirname "$ssl_dir")")
            add_service_if_linked "$svc_name"
        done < <(find "$SERVICES_ROOT" -mindepth 2 -maxdepth 2 -type d -name ssl -print0 2>/dev/null)
    fi
fi

if [ ${#linked_services[@]} -eq 0 ]; then
    echo "       Not linked to any service"
    echo "       Run 'gokku letsencrypt:link-nginx <service-name>' to link certificates"
fi

echo ""
echo "-----> Auto-renewal:"
if [ -f "/etc/cron.d/gokku-letsencrypt" ]; then
    echo "       Global auto-renewal: Enabled (/etc/cron.d/gokku-letsencrypt)"
else
    echo "       Global auto-renewal: Disabled"
fi

if [ -n "$SERVICE_FILTER" ]; then
    if [ -f "/etc/cron.d/gokku-letsencrypt-$SERVICE_FILTER" ]; then
        echo "       Service auto-renewal: Enabled (/etc/cron.d/gokku-letsencrypt-$SERVICE_FILTER)"
    else
        echo "       Service auto-renewal: Disabled"
    fi
fi
