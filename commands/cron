#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    # shellcheck disable=SC1091
    source /opt/gokku/scripts/plugin-helpers.sh
fi

SERVICE_NAME="$1"

if [ -z "$SERVICE_NAME" ]; then
    echo "Usage: $0 <nginx-service>"
    echo "Example: $0 nginx-lb"
    exit 1
fi

PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
SERVICES_ROOT="/opt/gokku/services"
SERVICE_DIR="$SERVICES_ROOT/$SERVICE_NAME"
CRON_FILE="/etc/cron.d/gokku-letsencrypt-$SERVICE_NAME"
LOG_FILE="/var/log/gokku-letsencrypt-$SERVICE_NAME.log"
GOKKU_BIN="$(command -v gokku || echo "/usr/local/bin/gokku")"

echo "-----> Setting up auto-renewal cron job for nginx service: $SERVICE_NAME"

if [ ! -d "$PLUGIN_DIR" ]; then
    echo "-----> Let's Encrypt plugin not installed"
    echo "       Run 'gokku letsencrypt:install' first"
    exit 1
fi

if [ ! -d "$SERVICE_DIR" ]; then
    echo "-----> Service directory not found: $SERVICE_DIR"
    exit 1
fi

mkdir -p "$SERVICE_DIR/ssl"

if [ ! -x "$GOKKU_BIN" ]; then
    echo "-----> Unable to locate executable 'gokku' binary (checked: $GOKKU_BIN)"
    exit 1
fi

cat > "$CRON_FILE" <<EOF
# Auto-renewal for Let's Encrypt nginx service: $SERVICE_NAME
# Runs every day at 2:30 AM
30 2 * * * root $GOKKU_BIN letsencrypt:renew $SERVICE_NAME >> $LOG_FILE 2>&1
EOF

chmod 644 "$CRON_FILE"

echo "-----> Auto-renewal cron job created successfully"
echo "       Cron file: $CRON_FILE"
echo "       Renewal command: $GOKKU_BIN letsencrypt:renew $SERVICE_NAME"
echo "       Schedule: Daily at 2:30 AM"
echo "       Log file: $LOG_FILE"

echo "-----> Testing renewal command..."
if "$GOKKU_BIN" letsencrypt:renew "$SERVICE_NAME"; then
    echo "-----> Renewal command test successful"
else
    echo "-----> Renewal command test failed (check logs above)"
fi

echo ""
echo "-----> Auto-renewal setup complete"
echo "       Certificates will be automatically renewed every 90 days"
echo "       Manual renewal: $GOKKU_BIN letsencrypt:renew $SERVICE_NAME"
