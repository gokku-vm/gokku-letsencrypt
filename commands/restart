#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    # shellcheck disable=SC1091
    source /opt/gokku/scripts/plugin-helpers.sh
fi

SERVICE_NAME="$1"

if [ -z "$SERVICE_NAME" ]; then
    echo "Usage: $0 <service-name>"
    echo "Example: $0 nginx-lb"
    exit 1
fi

PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
CERTS_DIR="$PLUGIN_DIR/certs"
SERVICES_ROOT="/opt/gokku/services"
SERVICE_DIR="$SERVICES_ROOT/$SERVICE_NAME"
SSL_DIR="$SERVICE_DIR/ssl"

echo "-----> Refreshing Let's Encrypt integration for nginx service: $SERVICE_NAME"

if [ ! -d "$PLUGIN_DIR" ]; then
    echo "-----> Let's Encrypt plugin not installed"
    exit 1
fi

if [ ! -d "$CERTS_DIR" ]; then
    echo "-----> No certificates found in plugin directory"
    exit 1
fi

if [ ! -d "$SERVICE_DIR" ]; then
    echo "-----> Service directory not found: $SERVICE_DIR"
    exit 1
fi

mkdir -p "$SSL_DIR"

echo "-----> Re-linking certificates"
linked_count=0
while IFS= read -r -d '' domain_dir; do
    domain=$(basename "$domain_dir")
    fullchain="$domain_dir/fullchain.pem"
    privkey="$domain_dir/privkey.pem"

    if [ -f "$fullchain" ] && [ -f "$privkey" ]; then
        ln -sf "$fullchain" "$SSL_DIR/$domain.crt"
        ln -sf "$privkey" "$SSL_DIR/$domain.key"
        echo "       Linked: $domain"
        linked_count=$((linked_count + 1))
    fi
done < <(find "$CERTS_DIR" -mindepth 1 -maxdepth 1 -type d -print0)

if [ $linked_count -eq 0 ]; then
    echo "       No certificates available to link"
fi

echo ""
echo "-----> SSL directory contents:"
if [ -d "$SSL_DIR" ] && compgen -G "$SSL_DIR/*" > /dev/null; then
    ls -1 "$SSL_DIR" | sed 's/^/       /'
else
    echo "       (empty)"
fi

echo ""
if [ -f "/etc/cron.d/gokku-letsencrypt-$SERVICE_NAME" ]; then
    echo "-----> Auto-renewal cron: /etc/cron.d/gokku-letsencrypt-$SERVICE_NAME"
else
    echo "-----> Auto-renewal cron: not configured for this service"
fi

if [ -f "/etc/cron.d/gokku-letsencrypt" ]; then
    echo "-----> Global auto-renewal cron: /etc/cron.d/gokku-letsencrypt"
fi

echo ""
echo "-----> Let's Encrypt integration refreshed"
echo "       Service: $SERVICE_NAME"
