#!/bin/bash

# Source Gokku helper functions
if [ -f "/opt/gokku/scripts/plugin-helpers.sh" ]; then
    source /opt/gokku/scripts/plugin-helpers.sh
fi

DOMAIN="$1"
EMAIL="$2"

if [ -z "$DOMAIN" ]; then
    echo "Usage: $0 <domain> [email]"
    echo "Example: $0 example.com admin@example.com"
    exit 1
fi

# Default email if not provided
if [ -z "$EMAIL" ]; then
    EMAIL="contact@$DOMAIN"
fi

echo "-----> Creating Let's Encrypt certificate for $DOMAIN"

# Check if plugin is installed
PLUGIN_DIR="/opt/gokku/plugins/letsencrypt"
if [ ! -d "$PLUGIN_DIR" ]; then
    echo "-----> Let's Encrypt plugin not installed"
    echo "       Run 'gokku letsencrypt:install' first"
    exit 1
fi

# Create certs directory if it doesn't exist
mkdir -p "$PLUGIN_DIR/certs"
mkdir -p "$PLUGIN_DIR/accounts"

# Check if certificate already exists (in certs/ or live/)
if [ -d "$PLUGIN_DIR/certs/$DOMAIN" ] && [ -f "$PLUGIN_DIR/certs/$DOMAIN/fullchain.pem" ]; then
    echo "-----> Certificate for $DOMAIN already exists"
    echo "       Certificate: $PLUGIN_DIR/certs/$DOMAIN/fullchain.pem"
    echo "       Private key: $PLUGIN_DIR/certs/$DOMAIN/privkey.pem"
    exit 0
fi

# Also check if it exists in live/ but not in certs/
if [ -d "$PLUGIN_DIR/live/$DOMAIN" ] && [ ! -d "$PLUGIN_DIR/certs/$DOMAIN" ]; then
    echo "-----> Certificate exists in live/ directory, copying to certs/"
    mkdir -p "$PLUGIN_DIR/certs/$DOMAIN"
    cp -Lf "$PLUGIN_DIR/live/$DOMAIN/fullchain.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null || sudo cp -Lf "$PLUGIN_DIR/live/$DOMAIN/fullchain.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null
    cp -Lf "$PLUGIN_DIR/live/$DOMAIN/privkey.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null || sudo cp -Lf "$PLUGIN_DIR/live/$DOMAIN/privkey.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null
    if [ -f "$PLUGIN_DIR/certs/$DOMAIN/fullchain.pem" ]; then
        echo "-----> Certificate for $DOMAIN already exists"
        exit 0
    fi
fi

# Create certificate using certbot
echo "-----> Requesting certificate from Let's Encrypt..."

# Find and temporarily stop nginx containers that are using port 80
CONTAINERS_TO_RESTART=()
echo "-----> Checking for containers on port 80..."

# Find containers exposing port 80 (HTTP-01 validation only needs port 80)
for container in $(docker ps --format "{{.Names}}"); do
    # Check if container is exposing port 80
    if docker port "$container" 2>/dev/null | grep -qE ":80/"; then
        echo "-----> Found container using port 80: $container"
        echo "       Temporarily stopping for certificate generation..."
        docker stop "$container" > /dev/null 2>&1
        CONTAINERS_TO_RESTART+=("$container")
    fi
done

# Use standalone mode for initial certificate (HTTP-01 validation only needs port 80)
docker run --rm \
    -v "$PLUGIN_DIR:/etc/letsencrypt" \
    -v "$PLUGIN_DIR/logs:/var/log/letsencrypt" \
    -p 80:80 \
    certbot/certbot certonly \
    --standalone \
    --preferred-challenges http \
    --non-interactive \
    --agree-tos \
    --email "$EMAIL" \
    --domains "$DOMAIN" \
    --config-dir "/etc/letsencrypt" \
    --work-dir "/etc/letsencrypt" \
    --logs-dir "/var/log/letsencrypt"

CERT_EXIT_CODE=$?

# Restart containers that were temporarily stopped
if [ ${#CONTAINERS_TO_RESTART[@]} -gt 0 ]; then
    echo "-----> Restarting temporarily stopped containers..."
    for container in "${CONTAINERS_TO_RESTART[@]}"; do
        echo "       Restarting: $container"
        docker start "$container" > /dev/null 2>&1
    done
fi

# Fix permissions for files created by certbot (root in Docker)
if [ -d "$PLUGIN_DIR" ]; then
    if ! chmod -R u+rwX "$PLUGIN_DIR" 2>/dev/null; then
        echo "-----> Fixing permissions on root-owned files..."
        sudo chown -R "$(whoami):$(whoami)" "$PLUGIN_DIR" 2>/dev/null || true
        chmod -R 755 "$PLUGIN_DIR" 2>/dev/null || true
    fi
fi

if [ $CERT_EXIT_CODE -eq 0 ]; then
    echo "-----> Certificate created successfully"
    
    # Move certificates from live/ to certs/ directory structure
    if [ -d "$PLUGIN_DIR/live/$DOMAIN" ]; then
        mkdir -p "$PLUGIN_DIR/certs/$DOMAIN"
        cp -Lf "$PLUGIN_DIR/live/$DOMAIN/fullchain.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null || sudo cp -Lf "$PLUGIN_DIR/live/$DOMAIN/fullchain.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null
        cp -Lf "$PLUGIN_DIR/live/$DOMAIN/privkey.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null || sudo cp -Lf "$PLUGIN_DIR/live/$DOMAIN/privkey.pem" "$PLUGIN_DIR/certs/$DOMAIN/" 2>/dev/null
        echo "       Domain: $DOMAIN"
        echo "       Certificate: $PLUGIN_DIR/certs/$DOMAIN/fullchain.pem"
        echo "       Private key: $PLUGIN_DIR/certs/$DOMAIN/privkey.pem"
    fi

    # Update plugin configuration
    if [ -f "$PLUGIN_DIR/plugin.conf" ]; then
        # Add domain to plugin config
        if command -v jq > /dev/null 2>&1; then
            jq --arg domain "$DOMAIN" '.domains += [$domain]' "$PLUGIN_DIR/plugin.conf" > "$PLUGIN_DIR/plugin.conf.tmp" && mv "$PLUGIN_DIR/plugin.conf.tmp" "$PLUGIN_DIR/plugin.conf"
        fi
    fi

    echo ""
    echo "-----> Next steps:"
    echo "       1. Link to nginx service: gokku letsencrypt:link-nginx <nginx-service>"
    echo "       2. Setup auto-renewal: gokku letsencrypt:auto-renew"
else
    echo "-----> Failed to create certificate"
    echo "       Check logs: $PLUGIN_DIR/logs/"
    exit 1
fi
